{"version":3,"file":"watch.js","sources":["../src/lib/watch.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2023 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {DirectiveResult, Part, directive} from 'lit/directive.js';\nimport {AsyncDirective} from 'lit/async-directive.js';\nimport {Signal} from 'signal-polyfill';\nimport {SignalWatcher} from './signal-watcher.js';\n\n// Watcher for directives that are not associated with a host element.\nlet effectsPending = false;\nconst hostlessWatcher = new Signal.subtle.Watcher(async () => {\n  if (effectsPending) {\n    return;\n  }\n  effectsPending = true;\n  queueMicrotask(() => {\n    effectsPending = false;\n    for (const signal of hostlessWatcher.getPending()) {\n      signal.get();\n    }\n    hostlessWatcher.watch();\n  });\n});\n\nexport class WatchDirective<T> extends AsyncDirective {\n  private __host?: SignalWatcher;\n\n  private __signal?: Signal.State<T> | Signal.Computed<T>;\n\n  private __watcher?: Signal.subtle.Watcher;\n\n  private __computed: Signal.Computed<T | undefined> | undefined;\n\n  private __watch() {\n    if (this.__watcher !== undefined) {\n      return;\n    }\n    this.__computed = new Signal.Computed(() => {\n      const value = this.__signal?.get();\n      this.setValue(value);\n      return value;\n    });\n    this.__watcher = this.__host?._watcher ?? hostlessWatcher;\n    this.__watcher.watch(this.__computed);\n    // get to trigger watcher but untracked so it's not part of performUpdate\n    Signal.subtle.untrack(() => this.__computed?.get());\n  }\n\n  private __unwatch() {\n    if (this.__watcher !== undefined) {\n      this.__watcher.unwatch(this.__signal!);\n      this.__watcher = undefined;\n    }\n  }\n\n  render(signal: Signal.State<T> | Signal.Computed<T>): T {\n    // This would only be called if render is called directly, like in SSR.\n    return Signal.subtle.untrack(() => signal.get());\n  }\n\n  override update(\n    part: Part,\n    [signal]: [signal: Signal.State<T> | Signal.Computed<T>]\n  ) {\n    this.__host ??= part.options?.host as SignalWatcher;\n    if (signal !== this.__signal && this.__signal !== undefined) {\n      // Unwatch the old signal\n      this.__unwatch();\n    }\n    this.__signal = signal;\n    this.__watch();\n    // We use untrack() so that the signal access is not tracked by the watcher\n    // created by SignalWatcher. This means that an can use both SignalWatcher\n    // and watch() and a signal update won't trigger a full element update if\n    // it's only passed to watch() and not otherwise accessed by the element.\n    return Signal.subtle.untrack(() => this.__signal!.get());\n  }\n\n  protected override disconnected(): void {\n    this.__unwatch();\n  }\n\n  protected override reconnected(): void {\n    this.__watch();\n  }\n}\n\nexport type WatchDirectiveFunction = <T>(\n  signal: Signal.State<T> | Signal.Computed<T>\n) => DirectiveResult<typeof WatchDirective<T>>;\n\n/**\n * Renders a signal and subscribes to it, updating the part when the signal\n * changes.\n *\n * watch() can only be used in a reactive element that applies the\n * SignalWatcher mixin.\n */\nexport const watch = directive(WatchDirective) as WatchDirectiveFunction;\n"],"names":["effectsPending","hostlessWatcher","Signal","subtle","Watcher","async","queueMicrotask","signal","getPending","get","watch","WatchDirective","AsyncDirective","__watch","undefined","this","__watcher","__computed","Computed","value","_a","__signal","setValue","_b","__host","_watcher","untrack","__unwatch","unwatch","render","update","part","options","host","disconnected","reconnected","directive"],"mappings":";;;;;;AAYA,IAAIA,GAAiB,EACrB,MAAMC,EAAkB,IAAIC,EAAOC,OAAOC,QAAQC,UAC5CL,IAGJA,GAAiB,EACjBM,eAAe,KACbN,GAAiB,EACjB,IAAK,MAAMO,KAAUN,EAAgBO,aACnCD,EAAOE,MAETR,EAAgBS,aAId,MAAOC,UAA0BC,EAS7B,IAAAC,gBACiBC,IAAnBC,KAAKC,OAGTD,KAAKE,KAAa,IAAIf,EAAOgB,SAAS,WACpC,MAAMC,EAAqB,QAAbC,EAAAL,KAAKM,YAAQ,IAAAD,OAAA,EAAAA,EAAEX,MAE7B,OADAM,KAAKO,SAASH,GACPA,IAETJ,KAAKC,KAAiC,QAArBO,EAAW,QAAXH,EAAAL,KAAKS,YAAM,IAAAJ,OAAA,EAAAA,EAAEK,SAAQ,IAAAF,EAAAA,EAAItB,EAC1Cc,KAAKC,KAAUN,MAAMK,KAAKE,MAE1Bf,EAAOC,OAAOuB,QAAQ,KAAK,IAAAN,EAAC,OAAe,UAAfL,KAAKE,YAAU,IAAAG,OAAA,EAAAA,EAAEX,QAC/C,CAEQ,IAAAkB,QACiBb,IAAnBC,KAAKC,OACPD,KAAKC,KAAUY,QAAQb,KAAKM,MAC5BN,KAAKC,UAAYF,EAErB,CAEA,MAAAe,CAAOtB,GAEL,OAAOL,EAAOC,OAAOuB,QAAQ,IAAMnB,EAAOE,MAC5C,CAES,MAAAqB,CACPC,GACCxB,YAaD,OAXW,QAAXa,EAAAL,KAAKS,YAAM,IAAAJ,IAAXL,KAAKS,KAAuB,QAAZD,EAAAQ,EAAKC,eAAO,IAAAT,OAAA,EAAAA,EAAEU,MAC1B1B,IAAWQ,KAAKM,WAA8BP,IAAlBC,KAAKM,MAEnCN,KAAKY,OAEPZ,KAAKM,KAAWd,EAChBQ,KAAKF,OAKEX,EAAOC,OAAOuB,QAAQ,IAAMX,KAAKM,KAAUZ,MACpD,CAEmB,YAAAyB,GACjBnB,KAAKY,MACP,CAEmB,WAAAQ,GACjBpB,KAAKF,MACP,QAcWH,EAAQ0B,EAAUzB"}